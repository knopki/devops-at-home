---
- hosts: mir3g.1984.run
  any_errors_fatal: true
  become: true
  handlers:
    - name: uci commit
      uci:
        command: commit
  roles:
    - gekmihesg.openwrt
  tasks:
    #
    # Packages
    #
    - name: Uninstall packages
      opkg:
        name: "{{ item }}"
        state: absent
      with_items:
        - dnsmasq
      tags: opkg

    - name: Install packages
      opkg:
        name: "{{ item }}"
        state: present
      with_items:
        - ca-certificates
        - cjdns
        - conntrack
        - dnsmasq-full
        - ip-full
        - ipset
        - iptables
        - kmod-ipt-ipset
        - kmod-ipt-nat6
        - kmod-nf-nat6
        - libustream-openssl
        - luci
        - luci-app-cjdns
        - luci-app-ddns
        - luci-app-mwan3
        - luci-app-openvpn
        - luci-app-sqm
        - luci-app-wireguard
        - luci-app-wol
        - openssl-util
        - openvpn-openssl
        - python-crypto
        - python-light
        - python-logging
        - resolveip
        - shadow-usermod
        - tcpdump
        - uclient-fetch
      tags: opkg

    #
    # Users
    #
    - name: Set root password
      tags: users
      user:
        name: root
        password: "{{ root_password|password_hash('md5', 65534|random(seed=inventory_hostname)|string) }}"
        update_password: always

    - name: Set authorized key
      tags: users, ssh
      authorized_key:
        user: root
        state: present
        key: "{{ ssh_sk_pub_key }}"
        path: /etc/dropbear/authorized_keys
        manage_dir: no
        exclusive : yes

    #
    # CJDNS
    #
    - name: Set cjdns common settings
      uci:
        command: set
        key: cjdns.cjdns
        type: cjdns
        value:
          ipv6: "{{ lookup('passwordstore', 'devices/mir3g.1984.run/cjdns subkey=ipv6') }}"
          admin_password: "{{ lookup('passwordstore', 'devices/mir3g.1984.run/cjdns subkey=admin_password') }}"
          admin_port: 11234
          public_key: "{{ lookup('passwordstore', 'devices/mir3g.1984.run/cjdns subkey=public') }}"
          private_key: "{{ lookup('passwordstore', 'devices/mir3g.1984.run/cjdns subkey=private') }}"
          admin_address: '127.0.0.1'
          seccomp: '1'
          tun_device: 'tuncjdns'
      tags: uci, cjdns
      notify:
        - uci commit

    - name: Set cjdns peering interfaces (all)
      uci:
        command: section
        config: cjdns
        type: eth_interface
        find:
          bind: 'all'
        value:
          beacon: '0'
      tags: uci, cjdns
      notify:
        - uci commit

    - name: Set cjdns udp ipv4 binding
      uci:
        command: section
        config: cjdns
        type: udp_interface
        find:
          address: '0.0.0.0'
        value:
          port: '57338'
      tags: uci, cjdns
      notify:
        - uci commit

    - name: Set cjdns inbound credentials
      uci:
        command: section
        config: cjdns
        type: password
        find:
          user: "default-login"
        value:
          password: "{{ cjdns_authorizedPasswords['default-login'] }}"
      tags: uci, cjdns
      notify:
        - uci commit

    - name: Set cjdns inbound credentials
      uci:
        command: section
        config: cjdns
        type: password
        find:
          user: "private"
        value:
          password: "{{ cjdns_authorizedPasswords['private'] }}"
      tags: uci, cjdns
      notify:
        - uci commit

    - name: Set UCI variables (cjdns peers)
      tags: uci, cjdns
      uci:
        command: section
        config: cjdns
        find:
          peerName: "{{ item.peerName }}"
        type: udp_peer
        value:
          interface: "{{ '2' if item.address_type == 'ipv6' else '1' }}"
          address: "{{ item.address }}"
          port: "{{ item.port }}"
          public_key: "{{ item.publicKey }}"
          password: "{{ item.password }}"
          user: "{{ item.peerName }}"
          login: "{{ item.login|default(omit) }}"
      with_items: "{{ cjdns_udp_peers|difference(cjdns_udp_peers_self) }}"
      notify:
        - uci commit


    #
    # ddns
    #
    - uci:
        command: set
        key: ddns.global
        value:
          upd_privateip: '1'
      tags: uci, ddns
      notify:
        - uci commit

    - uci:
        command: section
        config: ddns
        type: service
        find:
          domain: "mir3g.1984.run"
        value:
          interface: wan
          service_name: google.com
          ip_source: network
          ip_network: "wan"
          enabled: "1"
          lookup_host: "mir3g.1984.run"
          username: "{{ lookup('passwordstore','devices/mir3g.1984.run/google_ddns subkey=username') }}"
          password: "{{ lookup('passwordstore','devices/mir3g.1984.run/google_ddns') }}"
          use_https: "1"
          cacert: "IGNORE"
      tags: uci, ddns
      notify:
        - uci commit

    #
    # DHCP
    #
    - uci:
        command: set
        key: dhcp.@dnsmasq[0]
        type: dnsmasq
        value:
          domainneeded: '1'
          boguspriv: '1'
          filterwin2k: '0'
          localise_queries: '1'
          rebind_protection: '1'
          rebind_localhost: '1'
          local: '/lan/'
          domain: 'lan'
          expandhosts: '1'
          nonegcache: '1'
          authoritative: '1'
          readethers: '1'
          leasefile: '/tmp/dhcp.leases'
          resolvfile: '/tmp/resolv.conf.auto'
          nonwildcard: '1'
          localservice: '1'
          strictorder: '1'
          interface: "br-lan"
          server:
            - '10.99.0.1'
            - '193.138.219.228'
      tags: uci, dhcp
      notify:
        - uci commit

    - uci:
        command: set
        key: dhcp.lan
        type: dhcp
        value:
          interface: 'lan'
          start: '100'
          limit: '150'
          leasetime: '12h'
          # dhcpv6: 'server'
          # ra: 'server'
          # ra_management: '60'
      tags: uci, dhcp
      notify:
        - uci commit

    - uci:
        command: set
        key: dhcp.wan
        type: dhcp
        value:
          interface: 'wan'
          ignore: '1'
      tags: uci, dhcp
      notify:
        - uci commit

    - uci:
        command: set
        key: dhcp.odhcpd
        type: odhcpd
        value:
          maindhcp: '0'
          leasefile: '/tmp/hosts/odhcpd'
          leasetrigger: '/usr/sbin/odhcpd-update'
          loglevel: '4'
      tags: uci, dhcp
      notify:
        - uci commit

    # static leases
    - uci:
        command: section
        config: dhcp
        type: host
        find:
          name: osmc
          mac: 'B8:27:EB:26:20:A9'
        value:
          dns: '1'
          ip: '10.66.6.20'
          leasetime: '1d'
      tags: uci, dhcp
      notify:
        - uci commit

    - uci:
        command: section
        config: dhcp
        type: host
        find:
          name: alien
          mac: '9C:B6:D0:03:A3:8F'
        value:
          dns: '1'
          ip: '10.66.6.100'
          leasetime: '1d'
      tags: uci, dhcp
      notify:
        - uci commit

    - uci:
        command: section
        config: dhcp
        type: host
        find:
          name: mi5sergey
          mac: '34:80:B3:6D:09:B4'
        value:
          dns: '1'
          ip: '10.66.6.101'
          leasetime: '1d'
      tags: uci, dhcp
      notify:
        - uci commit

    - uci:
        command: section
        config: dhcp
        type: host
        find:
          name: air-olga
          mac: '30:35:AD:BC:E7:EC'
        value:
          dns: '1'
          ip: '10.66.6.102'
          leasetime: '1d'
      tags: uci, dhcp
      notify:
        - uci commit

    - uci:
        command: section
        config: dhcp
        type: host
        find:
          name: mi5olga
          mac: '74:23:44:8E:23:7B'
        value:
          dns: '1'
          ip: '10.66.6.103'
          leasetime: '1d'
      tags: uci, dhcp
      notify:
        - uci commit


    #
    # Dropbear
    #
    - uci:
        command: set
        key: dropbear.@dropbear[0]
        type: dropbear
        value:
          Port: "22"
          GatewayPorts: "on"
          PasswordAuth: "off"
          RootPasswordAuth: "off"
      tags: uci, ssh
      notify:
        - uci commit

    #
    # Wake-on-lan
    #
    - uci:
        command: section
        config: etherwake
        type: setup
        find:
          interface: "br-lan"
        value:
          pathes: "/usr/bin/etherwake /usr/bin/ether-wake"
          sudo: "off"
          broadcast: "off"
      tags: uci, wol
      notify:
        - uci commit

      # Example:
      #   command: set
      #   key: etherwake.@target[0]
      #   value:
      #     name: example
      #     mac: "11:22:33:44:55:66"
      #     password: "sdfasdf"
      #     wakeonboot: "off"


    #
    # Firewall
    #

    # ip masq6
    - file:
        path: /etc/firewall.d/with_reload
        recursive: yes
        state: directory
      tags: firewall
    - name: Copy ipv6 nat script
      copy:
        src: files/90-nat6.fw
        dest: /etc/firewall.d/with_reload/90-nat6.fw
        mode: 0755
      tags: firewall

    # defaults
    - uci:
        command: set
        key: firewall.@defaults[0]
        type: defaults
        value:
          synflood_protect: '1'
          drop_invalid: '1'
          input: 'REJECT'
          output: 'ACCEPT'
          forward: 'REJECT'
          flow_offloading: '0'
          flow_offloading_hw: '0'
      tags: uci, firewall
      notify:
        - uci commit

    # zones
    - uci:
        command: section
        config: firewall
        type: zone
        find:
          name: 'lan'
        value:
          input: 'REJECT'
          output: 'ACCEPT'
          forward: 'ACCEPT'
          network: 'lan'
          log: '1'
          log_limit: '10/minute'
      tags: uci, firewall
      notify:
        - uci commit

    - uci:
        command: section
        config: firewall
        type: zone
        find:
          name: 'wan'
        value:
          input: 'REJECT'
          output: 'ACCEPT'
          forward: 'REJECT'
          network: 'wan'
          masq: '1'
          mtu_fix: '1'
          conntrack: '1'
          log: '1'
          log_limit: '10/minute'
      tags: uci, firewall
      notify:
        - uci commit

    - uci:
        command: section
        config: firewall
        type: zone
        find:
          name: 'cjdns'
        value:
          input: 'REJECT'
          output: 'ACCEPT'
          forward: 'REJECT'
          network: 'cjdns'
          conntrack: '1'
          log: '1'
          log_limit: '10/minute'
      tags: uci, firewall
      notify:
        - uci commit

    - uci:
        command: section
        config: firewall
        type: zone
        find:
          name: 'vpn'
        value:
          input: 'REJECT'
          output: 'ACCEPT'
          forward: 'REJECT'
          network: 'wg0'
          masq: '1'
          masq6: '1'
          mtu_fix: '1'
          conntrack: '1'
          log: '1'
          log_limit: '10/minute'
      tags: uci, firewall
      notify:
        - uci commit

    - uci:
        command: section
        config: firewall
        type: zone
        find:
          name: 'warriors'
        value:
          input: 'ACCEPT'
          output: 'ACCEPT'
          forward: 'REJECT'
          network: 'wg1 ovpn1'
          mtu_fix: '1'
          conntrack: '1'
          log: '1'
          log_limit: '10/minute'
      tags: uci, firewall, openvpn
      notify:
        - uci commit

    # forwarding
    - uci:
        command: set
        key: firewall.@forwarding[0]
        type: forwarding
        value:
          src: 'lan'
          dest: 'wan'
      tags: uci, firewall
      notify:
        - uci commit

    - uci:
        command: set
        key: firewall.@forwarding[1]
        type: forwarding
        value:
          src: 'lan'
          dest: 'vpn'
      tags: uci, firewall
      notify:
        - uci commit

    - uci:
        command: set
        key: firewall.@forwarding[2]
        type: forwarding
        value:
          src: 'lan'
          dest: 'warriors'
      tags: uci, firewall
      notify:
        - uci commit

    - uci:
        command: set
        key: firewall.@forwarding[3]
        type: forwarding
        value:
          src: 'warriors'
          dest: 'vpn'
      tags: uci, firewall
      notify:
        - uci commit

    - uci:
        command: set
        key: firewall.@forwarding[4]
        type: forwarding
        value:
          src: 'warriors'
          dest: 'wan'
      tags: uci, firewall
      notify:
        - uci commit

    - uci:
        command: set
        key: firewall.@forwarding[5]
        type: forwarding
        value:
          src: 'warriors'
          dest: 'lan'
      tags: uci, firewall
      notify:
        - uci commit
    # rules
    # ICMPv4 ###################################################################
    - name: 'any2self-Allow-Ping'
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: 'any2self-Allow-Ping'
        value:
          enabled: '1'
          family: ipv4
          src: '*'
          proto: icmp
          icmp_type: 'echo-request'
          target: ACCEPT
          limit: '1000/sec'
      tags: uci, firewall
      notify:
        - uci commit

    - name: 'any2any-Allow-Ping'
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: 'any2any-Allow-Ping'
        value:
          enabled: '1'
          family: ipv4
          src: '*'
          dest: '*'
          proto: icmp
          icmp_type: 'echo-request'
          target: ACCEPT
          limit: '1000/sec'
      tags: uci, firewall
      notify:
        - uci commit

    # ICMPv6 ###################################################################
    - name: lan2self-Allow-ICMPv6
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: lan2self-Allow-ICMPv6
        value:
          enabled: '1'
          src: 'lan'
          proto: 'icmp'
          icmp_type:
            - 'echo-request'
            - 'echo-reply'
            - 'destination-unreachable'
            - 'packet-too-big'
            - 'time-exceeded'
            - 'bad-header'
            - 'unknown-header-type'
            - 'router-solicitation'
            - 'neighbour-solicitation'
            - 'router-advertisement'
            - 'neighbour-advertisement'
          limit: '1000/sec'
          family: 'ipv6'
          target: 'ACCEPT'
      tags: uci, firewall
      notify:
        - uci commit

    - name: 'wan2self-Allow-ICMPv6'
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: 'wan2self-Allow-ICMPv6'
        value:
          enabled: '1'
          src: 'wan'
          proto: 'icmp'
          icmp_type:
            - 'echo-request'
            - 'echo-reply'
            - 'destination-unreachable'
            - 'packet-too-big'
            - 'time-exceeded'
            - 'bad-header'
            - 'unknown-header-type'
            - 'router-solicitation'
            - 'neighbour-solicitation'
            - 'router-advertisement'
            - 'neighbour-advertisement'
          limit: '1000/sec'
          family: 'ipv6'
          target: 'ACCEPT'
      tags: uci, firewall
      notify:
        - uci commit

    - name: 'cjdns2self-Allow-ICMPv6'
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: 'cjdns2self-Allow-ICMPv6'
        value:
          enabled: '1'
          src: 'cjdns'
          proto: 'icmp'
          icmp_type:
            - 'echo-request'
            - 'echo-reply'
            - 'destination-unreachable'
            - 'packet-too-big'
            - 'time-exceeded'
            - 'bad-header'
            - 'unknown-header-type'
          limit: '1000/sec'
          family: 'ipv6'
          target: 'ACCEPT'
      tags: uci, firewall
      notify:
        - uci commit

    - name: 'vpn2self-Allow-ICMPv6'
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: 'vpn2self-Allow-ICMPv6'
        value:
          enabled: '1'
          src: 'vpn'
          proto: 'icmp'
          icmp_type:
            - 'echo-request'
            - 'echo-reply'
            - 'destination-unreachable'
            - 'packet-too-big'
            - 'time-exceeded'
            - 'bad-header'
            - 'unknown-header-type'
            - 'router-solicitation'
            - 'neighbour-solicitation'
            - 'router-advertisement'
            - 'neighbour-advertisement'
          limit: '1000/sec'
          family: 'ipv6'
          target: 'ACCEPT'
      tags: uci, firewall
      notify:
        - uci commit

    - name: 'any2any-Allow-ICMPv6'
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: 'any2any-Allow-ICMPv6'
        value:
          enabled: '1'
          src: '*'
          dest: '*'
          proto: 'icmp'
          icmp_type:
            - 'echo-request'
            - 'echo-reply'
            - 'destination-unreachable'
            - 'packet-too-big'
            - 'time-exceeded'
            - 'bad-header'
            - 'unknown-header-type'
          limit: '1000/sec'
          family: 'ipv6'
          target: 'ACCEPT'
      tags: uci, firewall
      notify:
        - uci commit

    # IGMP/MLD #################################################################
    - name: 'wan2self-Allow-IGMP'
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: 'wan2self-Allow-IGMP'
        value:
          enabled: '1'
          src: 'wan'
          proto: 'igmp'
          family: 'ipv4'
          target: 'ACCEPT'
      tags: uci, firewall
      notify:
        - uci commit

    - name: wan2self-Allow-MLD
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: wan2self-Allow-MLD
        value:
          enabled: '1'
          src: 'wan'
          proto: 'icmp'
          src_ip: 'fe80::/10'
          icmp_type:
            - '130/0'
            - '131/0'
            - '132/0'
            - '143/0'
          family: 'ipv6'
          target: 'ACCEPT'
      tags: uci, firewall
      notify:
        - uci commit

    # IPSEC/ESP/AH/ISAKM #######################################################
    - name: wan2lan-Allow-IPSec-ESP
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: wan2lan-Allow-IPSec-ESP
        value:
          enabled: '1'
          src: 'wan'
          dest: 'lan'
          proto: 'esp'
          target: 'ACCEPT'
      tags: uci, firewall
      notify:
        - uci commit

    - name: wan2lan-Allow-IPSec-AH
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: wan2lan-Allow-IPSec-AH
        value:
          enabled: '1'
          src: 'wan'
          dest: 'lan'
          proto: 'ah'
          target: 'ACCEPT'
      tags: uci, firewall
      notify:
        - uci commit

    - name: 'wan2lan-Allow-ISAKMP'
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: 'wan2lan-Allow-ISAKMP'
        value:
          enabled: '1'
          src: 'wan'
          src_port: '500 4500'
          dest: 'lan'
          dest_port: '500 4500'
          proto: udp
          target: ACCEPT
      tags: uci, firewall
      notify:
        - uci commit

    - name: vpn2lan-Allow-IPSec-ESP
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: vpn2lan-Allow-IPSec-ESP
        value:
          enabled: '1'
          src: 'vpn'
          dest: 'lan'
          proto: 'esp'
          target: 'ACCEPT'
      tags: uci, firewall
      notify:
        - uci commit

    - name: vpn2lan-Allow-IPSec-AH
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: vpn2lan-Allow-IPSec-AH
        value:
          enabled: '1'
          src: 'vpn'
          dest: 'lan'
          proto: 'ah'
          target: 'ACCEPT'
      tags: uci, firewall
      notify:
        - uci commit

    - name: 'vpn2lan-Allow-ISAKMP'
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: 'vpn2lan-Allow-ISAKMP'
        value:
          enabled: '1'
          src: 'vpn'
          src_port: '500 4500'
          dest: 'lan'
          dest_port: '500 4500'
          proto: udp
          target: ACCEPT
      tags: uci, firewall
      notify:
        - uci commit

    # DHCP #####################################################################
    - name: 'wan2self-Allow-DHCP-Renew'
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: 'wan2self-Allow-DHCP-Renew'
        value:
          enabled: '1'
          src: 'wan'
          proto: 'udp'
          dest_port: '68'
          target: 'ACCEPT'
          family: 'ipv4'
      tags: uci, firewall
      notify:
        - uci commit

    - name: 'wan2self-Allow-DHCPv6'
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: 'wan2self-Allow-DHCPv6'
        value:
          enabled: '1'
          src: 'wan'
          proto: 'udp'
          src_ip: 'fc00::/6'
          dest_ip: 'fc00::/6'
          dest_port: '546'
          family: 'ipv6'
          target: 'ACCEPT'
      tags: uci, firewall
      notify:
        - uci commit

    - name: lan2self-Allow-DHCP-Server
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: lan2self-Allow-DHCP-Server
        value:
          enabled: '1'
          src: lan
          proto: udp
          dest_port: '67'
          target: 'ACCEPT'
          family: ipv4
      tags: uci, firewall
      notify:
        - uci commit

    - name: lan2self-Allow-DHCPv6-Server
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: lan2self-Allow-DHCPv6-Server
        value:
          enabled: '1'
          src: lan
          src_ip: 'fc00::/6'
          proto: udp
          dest_ip: 'fc00::/6'
          dest_port: '547'
          target: 'ACCEPT'
          family: ipv6
      tags: uci, firewall
      notify:
        - uci commit

    # DNS ######################################################################
    - name: lan2self-Allow-DNS
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: lan2self-Allow-DNS
        value:
          enabled: '1'
          src: lan
          dest_port: '53'
          target: 'ACCEPT'
      tags: uci, firewall
      notify:
        - uci commit

    # SSH ######################################################################
    - name: any2self-Allow-SSH
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: any2self-Allow-SSH
        value:
          enabled: '1'
          src: '*'
          proto: tcp
          dest_port: 22
          target: ACCEPT
          limit: '60/minute'
      tags: uci, firewall
      notify:
        - uci commit

    # Web interface ############################################################
    - name: any2self-Allow-Web
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: any2self-Allow-Web
        value:
          enabled: '1'
          src: '*'
          proto: tcp
          dest_port: 8080
          target: ACCEPT
          family: ipv4
      tags: uci, firewall
      notify:
        - uci commit

    - name: any2self-Allow-Webv6
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: any2self-Allow-Webv6
        value:
          enabled: '1'
          src: '*'
          proto: tcp
          dest_port: 80
          target: ACCEPT
          family: ipv6
          limit: '10/sec'
      tags: uci, firewall
      notify:
        - uci commit

    # CJDNS ####################################################################
    - name: any2self-Allow-CJDNS
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: any2self-Allow-CJDNS
        value:
          enabled: '1'
          src: '*'
          proto: udp
          dest_port: 57338
          target: ACCEPT
      tags: uci, firewall
      notify:
        - uci commit

    - name: wan2self-Allow-Wireguard
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: wan2self-Allow-Wireguard
        value:
          enabled: '1'
          src: wan
          proto: udp
          dest_port: 51820-51821
          target: ACCEPT
          family: ipv4
      tags: uci, firewall
      notify:
        - uci commit

    - name: any2self-Allow-OpenVPN
      uci:
        command: section
        config: firewall
        type: rule
        find:
          name: any2self-Allow-OpenVPN
        value:
          enabled: '1'
          src: '*'
          proto: udp
          dest_port: 1194
          target: ACCEPT
          family: ipv4
      tags: uci, firewall, openvpn
      notify:
        - uci commit


    #
    # port forwarding
    #

    - name: cjdns_alien dnat
      uci:
        command: section
        config: firewall
        type: redirect
        find:
          name: cjdns_alien
        value:
          enabled: 1
          target: DNAT
          src: wan
          src_dport: 57339
          dest: lan
          dest_port: 57338
          dest_ip: 10.66.6.100
          proto: udp
          reflection: 1
      tags: uci, firewall
      notify:
        - uci commit

    # - name: NAT reflection for CJDNS
    #   uci:
    #     command: section
    #     config: firewall
    #     type: redirect
    #     find:
    #       name: wan2lan-DNAT-CJDNS
    #     value:
    #       src: wan
    #       src_dport: 57338
    #       proto: udp
    #       dest: lan
    #       dest_ip: 10.66.6.1
    #       target: DNAT
    #       reflection: '1'
    #   tags: uci, firewall
    #   notify:
    #     - uci commit

    # addons
    - uci:
        command: set
        key: firewall.@include[0]
        type: include
        value:
          path: '/etc/firewall.user'
      tags: uci, firewall
      notify:
        - uci commit


    #
    # LuCi
    #
    - uci:
        command: set
        key: luci.main
        type: core
        value:
          lang: auto
          mediaurlbase: "/luci-static/bootstrap"
          resourcebase: "/luci-static/resources"
      tags: uci, luci
      notify:
        - uci commit

    - uci:
        command: set
        key: luci.flash_keep
        type: extern
        value:
          uci: "/etc/config/"
          dropbear: "/etc/dropbear/"
          openvpn: "/etc/openvpn/"
          passwd: "/etc/passwd"
          opkg: "/etc/opkg.conf"
          firewall: "/etc/firewall.user"
          uploads: "/lib/uci/upload/"
      tags: uci, luci
      notify:
        - uci commit

    - uci:
        command: set
        key: luci.sauth
        type: internal
        value:
          sessionpath: "/tmp/luci-sessions"
          sessiontime: "3600"
      tags: uci, luci
      notify:
        - uci commit

    - uci:
        command: set
        key: luci.ccache
        type: internal
        value:
          enable: "1"
      tags: uci, luci
      notify:
        - uci commit

    - uci:
        command: set
        key: luci.themes
        type: internal
        value:
          Bootstrap: "/luci-static/bootstrap"
      tags: uci, luci
      notify:
        - uci commit

    #
    # Network
    #
    - uci:
        command: set
        key: network.loopback
        type: interface
        value:
          ifname: lo
          proto: 'static'
          ipaddr: '127.0.0.1'
          netmask: '255.0.0.0'
      tags: uci, network
      notify:
        - uci commit

    - uci:
        command: set
        key: network.globals
        type: globals
        value:
          ula_prefix: 'dda4:bbdb:e32d::/48'
      tags: uci, network
      notify:
        - uci commit

    # lan bridge
    - uci:
        command: set
        key: network.lan
        type: interface
        value:
          ifname: eth0.1
          type: 'bridge'
          proto: 'static'
          ipaddr: '10.66.6.1'
          netmask: '255.255.255.0'
          ip6assign: '64'
      tags: uci, network
      notify:
        - uci commit

    - uci:
        command: set
        key: network.lan_dev
        type: device
        value:
          name: 'eth0.1'
          macaddr: '50:64:2b:19:2e:c4'
      tags: uci, network
      notify:
        - uci commit

    # wan
    - uci:
        command: set
        key: network.wan
        type: interface
        value:
          ifname: 'eth0.2'
          proto: 'dhcp'
          macaddr: 'D4:CA:6D:68:80:54'
          metric: '10'
      tags: uci, network
      notify:
        - uci commit

    # switches
    - uci:
        command: set
        key: network.@switch[0]
        type: switch
        value:
          name: 'switch0'
          reset: '1'
          enable_vlan: '1'
      tags: uci, network
      notify:
        - uci commit

    - uci:
        command: set
        key: network.@switch_vlan[0]
        type: switch_wlan
        value:
          device: 'switch0'
          vlan: '1'
          ports: '2 3 6t'
      tags: uci, network
      notify:
        - uci commit

    - uci:
        command: set
        key: network.@switch_vlan[1]
        type: switch_wlan
        value:
          device: 'switch0'
          vlan: '2'
          ports: '1 6t'
      tags: uci, network
      notify:
        - uci commit

    # cjdns
    - uci:
        command: set
        key: network.cjdns
        type: interface
        value:
          ifname: tuncjdns
          proto: 'none'
      tags: uci, network
      notify:
        - uci commit

    # wireguard
    - uci:
        command: set
        key: network.wg0
        type: interface
        value:
          proto: wireguard
          listen_port: 51821
          force_link: 1
          metric: '20'
          private_key: "{{ lookup('passwordstore', 'devices/mir3g.1984.run/wg-egress subkey=private') }}"
          addresses:
            - "{{ lookup('passwordstore', 'devices/mir3g.1984.run/wg-egress subkey=ip4') }}"
            - "{{ lookup('passwordstore', 'devices/mir3g.1984.run/wg-egress subkey=ip6') }}"
      tags: uci, network
      notify:
        - uci commit

    - uci:
        command: section
        config: network
        type: wireguard_wg0
        find:
          description: fi1-wireguard.mullvad.net
        value:
          endpoint_host: "{{ lookup('dig', 'fi1-wireguard.mullvad.net') }}"
          endpoint_port: 51820
          public_key: lA7gRTmiY9IcSQGXjOEaJjvgtO76BwYJsaaNQqemMWU=
          route_allowed_ips: 1
          allowed_ips:
            - 0.0.0.0/0
            - ::0/0
      tags: uci, network
      notify:
        - uci commit

    - name: wg1 interface
      uci:
        command: set
        key: network.wg1
        type: interface
        value:
          proto: wireguard
          listen_port: 51820
          force_link: 1
          private_key: "{{ lookup('passwordstore', 'devices/mir3g.1984.run/wg-ingress subkey=private') }}"
          addresses:
            - "10.66.7.65/27"
      tags: uci, network
      notify:
        - uci commit

    - name: wg1 peer mi5sergey
      uci:
        command: section
        config: network
        type: wireguard_wg1
        find:
          description: mi5sergey
        value:
          public_key: "{{ lookup('passwordstore', 'devices/Mi5Sergey/wg-home subkey=public') }}"
          route_allowed_ips: 1
          allowed_ips:
            - 10.66.7.66/32
          persistent_keepalive: 25
      tags: uci, network
      notify:
        - uci commit

    - name: wg1 peer mi5olga
      uci:
        command: section
        config: network
        type: wireguard_wg1
        find:
          description: mi5olga
        value:
          public_key: "{{ lookup('passwordstore', 'devices/Mi5Olga/wg-home subkey=public') }}"
          route_allowed_ips: 1
          allowed_ips:
            - 10.66.7.67/32
          persistent_keepalive: 25
      tags: uci, network
      notify:
        - uci commit

    - name: ovpn1 interface
      uci:
        command: set
        key: network.ovpn1
        type: interface
        value:
          proto: none
          ifname: ovpn1
          force_link: '1'
          delegate: '0'
          auto: '1'
      tags: uci, network, openvpn
      notify:
        - uci commit

    # static routing
    # - uci:
    #     command: section
    #     config: network
    #     type: route
    #     find:
    #       target: '10.66.7.0'
    #       netmask: '255.255.255.224'
    #     value:
    #       gateway: '10.66.7.5'
    #       interface: 'wg0'
    #       mtu: '1420'
    #       metric: '0'
    #   tags: uci, network
    #   notify:
    #     - uci commit

    #
    # sqm
    #
    - uci:
        command: section
        config: sqm
        type: queue
        find:
          interface: "eth0.2"
        value:
          linklayer: none
          enabled: "1"
          debug_logging: "0"
          verbosity: "2"
          download: "55000"
          upload: "55000"
          qdisc: cake
          script: piece_of_cake.qos
          qdisc_advanced: "1"
          ingress_ecn: ECN
          egress_ecn: NOECN
          qdisc_really_really_advanced: "0"
          squash_dscp: "0"
          squash_ingress: "0"
      tags: uci, sqm
      notify:
        - uci commit

    - uci:
        command: section
        config: sqm
        type: queue
        find:
          interface: "wg0"
        value:
          linklayer: "ethernet"
          overhead: "80"
          enabled: "1"
          debug_logging: "0"
          verbosity: "2"
          download: "55000"
          upload: "55000"
          qdisc: cake
          script: piece_of_cake.qos
          qdisc_advanced: "1"
          ingress_ecn: ECN
          egress_ecn: NOECN
          qdisc_really_really_advanced: "0"
          squash_dscp: "0"
          squash_ingress: "0"
      tags: uci, sqm
      notify:
        - uci commit


    #
    # system
    #
    - uci:
        command: set
        key: system.@system[0]
        type: system
        value:
          ttylogin: '0'
          log_size: '64'
          urandom_seed: '2342342'
          hostname: 'mir3g'
          zonename: 'Europe/Moscow'
          timezone: 'MSK-3'
          log_proto: 'udp'
          conloglevel: '8'
          cronloglevel: '8'
      tags: uci, system
      notify:
        - uci commit

    - uci:
        command: set
        key: system.ntp
        type: timeserver
        value:
          enabled: '1'
          server:
            - '0.ru.pool.ntp.org'
            - '1.ru.pool.ntp.org'
            - '2.ru.pool.ntp.org'
            - '3.ru.pool.ntp.org'
      tags: uci, system
      notify:
        - uci commit

    - uci:
        command: set
        key: system.led_wan_amber
        type: led
        value:
          name: 'WAN (amber)'
          sysfs: 'mir3g:amber:wan'
          trigger: 'switch0'
          port_mask: '0x02'
          speed_mask: '0x08'
      tags: uci, system
      notify:
        - uci commit

    - uci:
        command: set
        key: system.led_lan1_amber
        type: led
        value:
          name: 'LAN1 (amber)'
          sysfs: 'mir3g:amber:lan1'
          trigger: 'switch0'
          port_mask: '0x08'
          speed_mask: '0x08'
      tags: uci, system
      notify:
        - uci commit

    - uci:
        command: set
        key: system.led_lan2_amber
        type: led
        value:
          name: 'LAN2 (amber)'
          sysfs: 'mir3g:amber:lan2'
          trigger: 'switch0'
          port_mask: '0x04'
          speed_mask: '0x08'
      tags: uci, system
      notify:
        - uci commit


    #
    # uhttpd
    #
    - uci:
        command: set
        key: uhttpd.main
        type: uhttpd
        value:
          listen_http:
            - '0.0.0.0:8080'
            - '[::]:80'
          listen_https:
            - '[::]:443'
          redirect_https: "1"
          home: '/www'
          rfc1918_filter: '0'
          max_requests: '3'
          max_connections: '100'
          cert: '/etc/uhttpd.crt'
          key: '/etc/uhttpd.key'
          cgi_prefix: '/cgi-bin'
          lua_prefix: '/luci'
          lua_handler: '/usr/lib/lua/luci/sgi/uhttpd.lua'
          script_timeout: '60'
          network_timeout: '30'
          http_keepalive: '20'
          tcp_keepalive: '1'
          ubus_prefix: '/ubus'
      tags: uci, uhttpd
      notify:
        - uci commit

    - uci:
        command: set
        key: uhttpd.defaults
        type: cert
        value:
          days: '730'
          bits: '2048'
          country: 'ZZ'
          state: 'Somewhere'
          location: 'Unknown'
          commonname: 'OpenWrt'
      tags: uci, uhttpd
      notify:
        - uci commit

    #
    # wireless
    #
    - uci:
        command: set
        key: wireless.radio1
        type: wifi-device
        value:
          path: 'pci0000:00/0000:00:01.0/0000:02:00.0'
          type: 'mac80211'
          hwmode: '11a'
          htmode: 'VHT80'
          legacy_rates: '0'
          country: 'RU'
          distance: '10'
          channel: '52'
      tags: uci, wireless
      notify:
        - uci commit

    - uci:
        command: section
        config: wireless
        type: wifi-iface
        find:
          ssid: 'KotikiHQ_5'
        value:
          enabled: '1'
          device: 'radio1'
          network: 'lan'
          mode: 'ap'
          encryption: 'psk2'
          key: "{{ lookup('passwordstore','devices/mir3g.1984.run/KotikiHQ') }}"
      tags: uci, wireless
      notify:
        - uci commit

    #
    # mwan3
    #
    - name: mwan3 globals
      uci:
        command: set
        key: mwan3.globals
        type: globals
        value:
          local_source: 'lan'
          mmx_mask: '0x3F00'
      tags: uci, mwan3
      notify:
        - uci commit

    - name: mwan3 wan interface
      uci:
        command: set
        key: mwan3.wan
        type: interface
        value:
          enabled: '1'
          initial_state: 'online'
          family: 'ipv4'
          track_ip:
            - '77.37.251.33'
            - '77.37.255.30'
          track_method: 'ping'
          reliability: '1'
          count: '1'
          size: '56'
          timeout: '2'
          recovery_interval: '5'
          down: '3'
          up: '3'
          flush_conntrack: 'always'
          check_quality: '0'
          interval: '10'
          failure_interval: '10'
      tags: uci, mwan3
      notify:
        - uci commit

    - name: mwan3 wg0 interface
      uci:
        command: set
        key: mwan3.wg0
        type: interface
        value:
          enabled: '1'
          initial_state: 'online'
          family: 'ipv4'
          track_ip:
            - '10.64.0.1'
          track_method: 'ping'
          reliability: '1'
          count: '1'
          size: '56'
          timeout: '2'
          recovery_interval: '5'
          down: '3'
          up: '3'
          flush_conntrack: 'always'
          check_quality: '0'
          interval: '10'
          failure_interval: '10'
      tags: uci, mwan3
      notify:
        - uci commit

    - name: mwan3 wan_m1_w1 member
      uci:
        command: set
        key: mwan3.wan_m1_w1
        type: member
        value:
          interface: 'wan'
          metric: '1'
          weight: '1'
      tags: uci, mwan3
      notify:
        - uci commit

    - name: mwan3 wg0_m1_w1 member
      uci:
        command: set
        key: mwan3.wg0_m1_w1
        type: member
        value:
          interface: 'wg0'
          metric: '1'
          weight: '1'
      tags: uci, mwan3
      notify:
        - uci commit

    - name: mwan3 only_wan policy
      uci:
        command: set
        key: mwan3.only_wan
        type: policy
        value:
          last_resort: 'unreachable'
          use_member:
            - 'wan_m1_w1'
      tags: uci, mwan3
      notify:
        - uci commit

    - name: mwan3 only_wg0 policy
      uci:
        command: set
        key: mwan3.only_wg0
        type: policy
        value:
          last_resort: 'unreachable'
          use_member:
            - 'wg0_m1_w1'
      tags: uci, mwan3
      notify:
        - uci commit

    - name: mwan3 ssh rule
      uci:
        command: set
        key: mwan3.ssh
        type: rule
        value:
          src_ip: '10.66.6.0/23'
          dest_port: '22'
          proto: 'tcp'
          sticky: '0'
          use_policy: 'only_wan'
      tags: uci, mwan3
      notify:
        - uci commit

    - name: mwan3 openvpn rule
      uci:
        command: set
        key: mwan3.openvpn
        type: rule
        value:
          src_ip: '10.66.6.0/23'
          dest_port: '1194:1195'
          proto: 'udp'
          sticky: '0'
          use_policy: 'only_wan'
      tags: uci, mwan3
      notify:
        - uci commit

    - name: mwan3 mtproxy rule
      uci:
        command: set
        key: mwan3.mtproxy
        type: rule
        value:
          src_ip: '10.66.6.0/23'
          dest_ip: "{{ lookup('passwordstore','devices/do-fra1.1984.run/network_primary_ipv4') }}"
          dest_port: '1984'
          proto: 'udp'
          sticky: '0'
          use_policy: 'only_wan'
      tags: uci, mwan3
      notify:
        - uci commit

    - name: mwan3 wireguard rule
      uci:
        command: set
        key: mwan3.wireguard
        type: rule
        value:
          src_ip: '10.66.6.0/23'
          dest_port: '51820'
          proto: 'udp'
          sticky: '0'
          use_policy: 'only_wan'
      tags: uci, mwan3
      notify:
        - uci commit

    - name: mwan3 wireguard_src rule
      uci:
        command: set
        key: mwan3.wireguard_src
        type: rule
        value:
          src_ip: '10.66.6.0/23'
          src_port: '51820'
          proto: 'udp'
          sticky: '0'
          use_policy: 'only_wan'
      tags: uci, mwan3
      notify:
        - uci commit

    - name: mwan3 cjdns rule
      uci:
        command: set
        key: mwan3.cjdns
        type: rule
        value:
          src_ip: '10.66.6.0/23'
          src_port: '57338'
          proto: 'udp'
          sticky: '0'
          use_policy: 'only_wan'
      tags: uci, mwan3
      notify:
        - uci commit

    - name: mwan3 vuk rule
      uci:
        command: set
        key: mwan3.vuk
        type: rule
        value:
          src_ip: '10.66.6.0/23'
          dest_ip: '94.159.22.10/29'
          sticky: '0'
          use_policy: 'only_wan'
      tags: uci, mwan3
      notify:
        - uci commit

    - name: mwan3 default_ipv4 rule
      uci:
        command: set
        key: mwan3.default_ipv4
        type: rule
        value:
          src_ip: '10.66.6.0/23'
          proto: 'all'
          sticky: '0'
          use_policy: 'only_wg0'
      tags: uci, mwan3
      notify:
        - uci commit

    #
    # openvpn server
    #
    - name: Copy easy-rsa certs
      copy:
        content: "{{ lookup('passwordstore', 'devices/mir3g.1984.run/{{ item.key }} returnall=true') }}"
        dest: "{{ item.path }}"
      with_items:
        - key: ca.crt
          path: /etc/easy-rsa/pki/ca.crt
        - key: dh2048.pem
          path: /etc/easy-rsa/pki/dh2048.pem
        - key: ovpn-server.key
          path: /etc/easy-rsa/pki/private/mir3g.key
      tags: openvpn

    - name: openvpn server config
      uci:
        command: set
        key: openvpn.ovpn1
        type: openvpn
        value:
          enabled: '1'
          dev: ovpn1
          dev_type: tun
          topology: subnet
          proto: udp
          port: '1194'
          server: '10.66.7.0 255.255.255.224'
          ifconfig: '10.66.7.1 255.255.255.224'
          push:
            - 'route 10.66.6.0 255.255.255.0'
            - 'sndbuf 393216'
            - 'rcvbuf 393216'
          cipher: AES-256-CBC
          keepalive: '10 60'
          comp_lzo: adaptive
          client_to_client: '1'
          persist_key: '1'
          persist_tun: '1'
          persist_local_ip: '1'
          persist_remote_ip: '1'
          sndbuf: '393216'
          rcvbuf: '393216'
          fragment: '0'
          mssfix: '0'
          tun_mtu: '48000'
          fast_io: '1'
          dh: /etc/easy-rsa/pki/dh2048.pem
          ca: /etc/easy-rsa/pki/ca.crt
          cert: /etc/easy-rsa/pki/issued/mir3g.crt
          key: /etc/easy-rsa/pki/private/mir3g.key
      tags: uci, openvpn
      notify:
        - uci commit
